# Lock Viewer

A web-based visualization tool for LiteBox lock trace data.

## Overview

Lock Viewer reads JSONL lock trace data generated by LiteBox's lock tracing
feature and displays an interactive timeline visualization in your browser.

## Quick Start

The easiest way to run the server is with [uv](https://docs.astral.sh/uv/),
which automatically manages the Python environment and dependencies:

```bash
cd dev_tools/lock_viewer
uv run python3 server.py --file /tmp/locks.jsonl
```

That's it! Open http://localhost:5000 in your browser.

## Requirements

- Python 3.10+
- Flask (automatically installed by uv)

## Usage

1. Run a program with LiteBox (with `lock_tracing` feature enabled).
   This will generate `/tmp/locks.jsonl`.

2. Start the viewer server:
   ```bash
   cd dev_tools/lock_viewer
   uv run python3 server.py
   ```

3. Open http://localhost:5000 in your browser.

### Options

| Option | Default | Description |
|--------|---------|-------------|
| `--port PORT` | 5000 | Server port |
| `--file PATH` | /tmp/locks.jsonl | Path to locks.jsonl file |

### Examples

```bash
# Default usage (reads /tmp/locks.jsonl on port 5000)
uv run python3 server.py

# Use custom file and port
uv run python3 server.py --file ./my-trace.jsonl --port 8080
```

## Features

- **Summary Panel**: Shows total events recorded, events dropped due to buffer
  overflow, and buffer utilization percentage
- **Timeline View**: Visualize lock events on a timeline grouped by lock address
- **Lock Filter**: Click lock tags to show/hide specific locks
- **Event Type Filter**: Filter by attempt, acquired, or released events
- **Time Range**: Zoom into specific time ranges using the sliders
- **Hover Details**: Hover over event markers to see full details
- **Auto-reload**: Click "Reload Data" to refresh after new traces

## Project Structure

```
lock_viewer/
├── server.py           # Flask server
├── pyproject.toml      # Python project config (for uv)
├── requirements.txt    # Dependencies (for pip)
├── templates/
│   └── index.html      # Main HTML template
└── static/
    ├── css/
    │   └── style.css   # Styles
    └── js/
        └── app.js      # Client-side JavaScript
```

## JSONL Format

The first line is a summary object:
```json
{"type":"summary","recorded_events":12345,"dropped_events":0}
```

Each subsequent line is a lock event:
```json
{"event_type":"acquired","timestamp_ns":12345678,"lock_addr":"0x7fff123","lock_type":"Mutex","file":"src/foo.rs","line":42}
```

### Event Types

| Type | Description |
|------|-------------|
| `attempt` | Lock acquisition was attempted (before blocking) |
| `acquired` | Lock was successfully acquired |
| `released` | Lock was released |

### Lock Types

| Type | Description |
|------|-------------|
| `Mutex` | Mutual exclusion lock |
| `RwLockRead` | Read lock on a reader-writer lock |
| `RwLockWrite` | Write lock on a reader-writer lock |
